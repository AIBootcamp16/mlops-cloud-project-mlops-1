# COVID-19 ì „ì—¼ë³‘ ì˜ˆì¸¡ ë° ë°±ì‹  íš¨ê³¼ì„± ë¶„ì„ì„ ìœ„í•œ Docker ì´ë¯¸ì§€
FROM python:3.11-slim

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONUNBUFFERED=1
ENV JUPYTER_ENABLE_LAB=yes

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    vim \
    build-essential \
    libgdal-dev \
    gdal-bin \
    libspatialindex-dev \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
WORKDIR /workspace

# Python ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ìš© requirements.txt ìƒì„±
COPY requirements.txt .

# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# í•„ìˆ˜ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
RUN mkdir -p /workspace/data/raw && \
    mkdir -p /workspace/data/processed && \
    mkdir -p /workspace/notebooks && \
    mkdir -p /workspace/src && \
    mkdir -p /workspace/models && \
    mkdir -p /workspace/results && \
    mkdir -p /workspace/mlruns && \
    mkdir -p /workspace/mlflow-artifacts && \
    mkdir -p /workspace/config

# ğŸ¯ í˜„ì¬ ë””ë ‰í† ë¦¬ êµ¬ì¡°ì— ë§ì¶° ë³µì‚¬
# workspace ë””ë ‰í† ë¦¬ ì „ì²´ ë³µì‚¬
COPY workspace/ /workspace/

# ğŸ¯ MLflow ê²°ê³¼ë¬¼ ë³µì‚¬ (ë£¨íŠ¸ì—ì„œ)
COPY mlruns/ /workspace/mlruns/
COPY mlflow-artifacts/ /workspace/mlflow-artifacts/

# ğŸ¯ ë°ì´í„° ë³µì‚¬ (ë£¨íŠ¸ì—ì„œ)
COPY data/ /workspace/data/

# Jupyter ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /root/.jupyter

# Jupyter ì„¤ì • íŒŒì¼ ìƒì„±
RUN echo "c.ServerApp.token = ''" > /root/.jupyter/jupyter_server_config.py && \
    echo "c.ServerApp.password = ''" >> /root/.jupyter/jupyter_server_config.py && \
    echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_server_config.py && \
    echo "c.ServerApp.ip = '0.0.0.0'" >> /root/.jupyter/jupyter_server_config.py

# í¬íŠ¸ ë…¸ì¶œ (Jupyter Labìš©)
EXPOSE 8888

# ê¸°ë³¸ ëª…ë ¹ì–´
CMD ["jupyter", "lab", "--port=8888", "--no-browser", "--allow-root", "--ip=0.0.0.0"]